window.contConteditor=new function(){function a(a){$.ajax({url:"?PX=plugins.contedit.edit&mode=api&method="+a.apiMethod,success:function(b){a.success(b),c.standby(a.standbyKey)},error:function(){alert(a.apiMethod+" ERROR.")}})}function b(){c.winIframe=window.conteditUICanvas,g=$("#content",c.winIframe.document),g.html("<p>開発中です。</p>"),$("a",c.winIframe.document).each(function(){this.href="javascript:alert('編集中のため押せません。');",this.onclick="alert('編集中のため押せません。'); return false;"}),$("form",c.winIframe.document).each(function(){this.action="javascript:alert('編集中のため送信できません。');",this.onsubmit="alert('編集中のため送信できません。'); return false;"}),c.docModules=new c.cls.collections.documentModules(e.list),c.docModulesView=new c.cls.views.documentModules({collection:c.docModules}),c.docContents=new c.cls.collections.documentContents(f),c.docContentsView=new c.cls.views.documentContents({collection:c.docContents}),$("#content",c.winIframe.document).html(c.docContentsView.render().el),c.uiControlPanel=new contConteditor.cls.views.uiControlPanel({collection:c.docContents})}var c=this,d={canvas:!1,module_definitions:!1,document_contents:!1},e={},f=[],g=null;c.winIframe=null,c.cls={collections:{},models:{},views:{}},c.docModules={},c.docModulesView={},c.docContents={},c.docContentsView={},c.uiControlPanel={},c.uiWinEditElement={},function(){function a(){var a=$(document);$(".conteditUI-canvas").height(a.height())}$(window).load(function(){$(window).on("resize",function(){return a(),!0}),a(),$(".conteditUI-controlpanel").draggable()}),$(window).bind("unload",function(){return confirm("編集内容は保存されていません。画面を遷移してもよろしいですか？")?!0:!1})}(),this.standby=function(a){return d[a]=!0,this.isStandby()&&b(),!0},this.isStandby=function(){for(var a in d)if(!d[a])return!1;return!0},a({apiMethod:"get_module_definitions",standbyKey:"module_definitions",success:function(a){e=a}}),a({apiMethod:"get_document_contents",standbyKey:"document_contents",success:function(a){f=a.data}}),this.getModuleDefinitions=function(){return e},this.save=function(a){var b=c.docContents.toJSON();$.ajax({url:"?PX=plugins.contedit.edit&mode=api&method=save",data:{document_contents:b},success:function(b){return b.result?(window.location.href=a,void 0):(alert("ERROR: "+b.message),void 0)},error:function(){alert(opt.apiMethod+" ERROR.")}})}},function(a){a.cls.views.uiControlPanel=Backbone.View.extend({el:".conteditUI.conteditUI-controlpanel",initialize:function(){$(".conteditUI-add_element select").append(a.docModulesView.mk_modSelectOptions())},events:{"click .conteditUI-btn_cancel":"uiCancel","click .conteditUI-btn_save":"uiSave","submit .conteditUI-add_element":"uiAddNewElement"},uiCancel:function(){return confirm("編集内容は保存されていません。画面を遷移してもよろしいですか？")?!0:!1},uiSave:function(b){return a.save(b.target.href),!1},uiAddNewElement:function(a){a.preventDefault();var b=$(".conteditUI-add_element select option:selected").attr("value");if(!b)return alert("選択してください。"),this;var c={module_id:b};return this.collection.add(c),this}}),a.cls.models.uiWinEditElement=Backbone.Model.extend({defaults:{func:"text",type:"func",contentData:{}},initialize:function(){}}),a.cls.collections.uiWinEditElements=Backbone.Collection.extend({initialize:function(){},model:a.cls.models.uiWinEditElement}),a.cls.views.uiWinEditElement=Backbone.View.extend({tagName:"tr",initialize:function(){},events:{"change textarea":"update"},update:function(){var a=this.$el.find("textarea").val();this.model.set("contentData",{src:a})},template:_.template("<th><%- type %>: <%- func %></th><td><textarea></textarea></td>"),render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this}}),a.cls.views.uiWinEditElements=Backbone.View.extend({tagName:"div",initialize:function(){},events:{"click .conteditUI-btn_cancel":"uiCancel","click .conteditUI-btn_ok":"uiOk"},uiCancel:function(a){return a.preventDefault(),this.remove(),!1},uiOk:function(a){return a.preventDefault(),console.log(this.collection),alert("UTODO: 開発中です。"),this.remove(),!1},render:function(){return this.$el.addClass("conteditUI").addClass("conteditUI-uiWinEditElements").append('<div class="conteditUI-uiWinEditElements_brind"></div><div class="conteditUI-uiWinEditElements_windowBody"><table class="conteditUI-formTable"></table><div class="conteditUI-uiWinEditElements_btnWrap"><a href="" class="conteditUI-btn_cancel">Cancel</a><a href="" class="conteditUI-btn_ok">OK</a></div></div>'),this.collection.each(function(b){var c=new a.cls.views.uiWinEditElement({model:b});this.$el.find(".conteditUI-formTable").append(c.render().el)},this),$("body").append(this.$el),this}})}(window.contConteditor),function(a){var b=0;a.cls.models.documentContent=Backbone.Model.extend({defaults:{id:null,module_id:null,data:{},module_label:"unknown"},initialize:function(){this.set("id","autoid"+b++);var c=a.docModules.get({id:this.get("module_id")});this.set("module_label",c.get("label"))}}),a.cls.collections.documentContents=Backbone.Collection.extend({initialize:function(){},model:a.cls.models.documentContent}),a.cls.views.documentContent=Backbone.View.extend({tagName:"div",initialize:function(){this.model.on("destroy",this.remove,this)},events:{"click .cont_docCont_edit":"uiEdit","click .cont_docCont_delete":"uiDestroy"},uiEdit:function(){var b=a.docModules.get({id:this.model.get("module_id")}),c=b.get("template"),d=new a.cls.collections.uiWinEditElements;for(var e in c)"func"==c[e].type&&d.add(c[e]);new a.cls.views.uiWinEditElements({collection:d,docContId:this.model.get("id")}).render()},uiDestroy:function(){this.model.destroy()},remove:function(){this.$el.remove()},template:_.template('<div><%- module_label %>: <%- module_id %><button class="cont_docCont_edit">edit</button><button class="cont_docCont_delete">delete</button></div>'),render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this}}),a.cls.views.documentContents=Backbone.View.extend({tagName:"div",initialize:function(){this.collection.on("add",this.addNew,this)},events:{},addNew:function(b){var c=new a.cls.views.documentContent({model:b});this.$el.append(c.render().el)},render:function(){return this.collection.each(function(b){var c=new a.cls.views.documentContent({model:b});this.$el.append(c.render().el)},this),this}})}(window.contConteditor),function(a){a.cls.models.documentModule=Backbone.Model.extend({defaults:{id:null,category:null,name:null,label:"unknown"},initialize:function(){this.set("id",this.get("category")+"/"+this.get("name"))}}),a.cls.collections.documentModules=Backbone.Collection.extend({initialize:function(){},model:a.cls.models.documentModule}),a.cls.views.documentModule=Backbone.View.extend({tagName:"li",initialize:function(){},events:{},toggle:function(){},destroy:function(){},remove:function(){},template:_.template("<%- label %>"),render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this}}),a.cls.views.documentModules=Backbone.View.extend({tagName:"select",initialize:function(){},render:function(){return this.collection.each(function(b){var c=new a.cls.views.documentModule({model:b});this.$el.append(c.render().el)},this),this},mk_modSelectOptions:function(){var a="";return this.collection.each(function(b){a+='<option value="'+b.get("id")+'">',a+=b.get("label"),a+="</option>"},this),a}})}(window.contConteditor);