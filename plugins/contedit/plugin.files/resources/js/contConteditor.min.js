window.contConteditor=new function(){function a(a){$.ajax({url:"?PX=plugins.contedit.edit&mode=api&method="+a.apiMethod,success:function(b){a.success(b),c.standby(a.standbyKey)},error:function(){alert(a.apiMethod+" ERROR.")}})}function b(){d.winIframe=window.conteditUICanvas,h=$("#content",d.winIframe.document),h.html("<p>編集画面を準備しています。しばらくお待ち下さい。</p>"),$("a",d.winIframe.document).each(function(){this.href="javascript:alert('編集中のため押せません。');",this.onclick="alert('編集中のため押せません。'); return false;"}),$("form",d.winIframe.document).each(function(){this.action="javascript:alert('編集中のため送信できません。');",this.onsubmit="alert('編集中のため送信できません。'); return false;"}),d.docModules=new d.cls.collections.documentModules(f.list),d.docModulesView=new d.cls.views.documentModules({collection:d.docModules}),d.docContents=new d.cls.collections.moduleContents(g),d.docContentsView=new d.cls.views.moduleContents({collection:d.docContents}),$("#content",d.winIframe.document).html(d.docContentsView.render().el),d.uiControlPanel=new contConteditor.cls.views.uiControlPanel({collection:d.docContents})}var c=this,d=this,e={canvas:!1,module_definitions:!1,document_contents:!1},f={},g=[],h=null;c.winIframe=null,c.cls={collections:{},models:{},views:{},editElementUiViews:{}},c.docModules={},c.docModulesView={},c.docContents={},c.docContentsView={},c.uiControlPanel={},c.uiWinEditElement={},function(){function a(){var a=$(document);$(".conteditUI-canvas").height(a.height())}$(window).load(function(){$(window).on("resize",function(){return a(),!0}),a(),$(".conteditUI-controlpanel").draggable()}),$(window).bind("beforeunload",function(){return"編集内容は保存されていません。画面を遷移してもよろしいですか？"})}(),this.standby=function(a){return e[a]=!0,this.isStandby()&&b(),!0},this.isStandby=function(){for(var a in e)if(!e[a])return!1;return!0},a({apiMethod:"get_module_definitions",standbyKey:"module_definitions",success:function(a){f=a}}),a({apiMethod:"get_document_contents",standbyKey:"document_contents",success:function(a){g=a.data}}),this.getModuleDefinitions=function(){return f},this.save=function(a){var b=c.docContents.toJSON();$.ajax({url:"?PX=plugins.contedit.edit&mode=api&method=save",data:{document_contents:b},success:function(b){return b.result?(window.location.href=a,void 0):(alert("ERROR: "+b.message),void 0)},error:function(){alert(opt.apiMethod+" ERROR.")}})}},function(a){a.cls.views.uiControlPanel=Backbone.View.extend({el:".conteditUI.conteditUI-controlpanel",initialize:function(){this.$el.find(".conteditUI-add_element select").append(a.docModulesView.mk_modSelectOptions())},events:{"click .conteditUI-btn_cancel":"uiCancel","click .conteditUI-btn_save":"uiSave","submit .conteditUI-add_element":"uiAddNewElement"},uiCancel:function(){return confirm("編集内容は保存されていません。画面を遷移してもよろしいですか？")?($(window).unbind("beforeunload"),!0):!1},uiSave:function(b){return a.save(b.target.href),$(window).unbind("beforeunload"),!1},uiAddNewElement:function(a){a.preventDefault();var b=this.$el.find(".conteditUI-add_element select option:selected").attr("value");if(!b)return alert("選択してください。"),this;var c={module_id:b};return this.collection.add(c),this}});var b=Backbone.Model.extend({defaults:{edit_element_id:null,func:"text",type:"func",content_data:{}},initialize:function(){}});a.cls.collections.uiWinEditElements=Backbone.Collection.extend({initialize:function(){},model:b}),a.cls.views.uiWinEditElementBase=Backbone.View.extend({tagName:"tr",initialize:function(){},events:{"change textarea":"update"},update:function(){var a=this.$el.find("textarea").val();this.model.set("content_data",{src:a})},template:_.template("<th><%- type %>: <%- func %></th><td><textarea></textarea></td>"),render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this.model.get("content_data")&&this.$el.find("textarea").val(this.model.get("content_data").src),this}}),a.cls.views.uiWinEditElements=Backbone.View.extend({tagName:"div",initialize:function(){return this},events:{"click .conteditUI-btn_cancel":"uiCancel","submit form":"uiCancel","click .conteditUI-btn_ok":"uiOk"},setTargetModel:function(a){return this.moduleContentModel=a,this},uiCancel:function(a){return a.preventDefault(),this.remove(),!1},uiOk:function(a){a.preventDefault();var b={};return this.collection.each(function(a){b[a.get("edit_element_id")]=a.get("content_data")},this),this.moduleContentModel.set("content_data",b),this.remove(),!1},render:function(){this.$el.addClass("conteditUI").addClass("conteditUI-uiWinEditElements").append('<div class="conteditUI-uiWinEditElements_brind"></div><div class="conteditUI-uiWinEditElements_windowBody"><form action="javascript:;"><table class="conteditUI-formTable"></table><div class="conteditUI-uiWinEditElements_btnWrap"><a href="" class="conteditUI-btn_cancel">Cancel</a><a href="" class="conteditUI-btn_ok">OK</a></form></div></div>');var b=this.moduleContentModel;return this.collection.each(function(c){c.set("content_data",b.get("content_data")[c.get("edit_element_id")]);var d;d=a.cls.editElementUiViews[c.get("func")]?new(a.cls.editElementUiViews[c.get("func")])({model:c}):new a.cls.views.uiWinEditElementBase({model:c}),this.$el.find(".conteditUI-formTable").append(d.render().el)},this),$("body").append(this.$el),this}})}(window.contConteditor),function(a){a.cls.models.documentModule=Backbone.Model.extend({idAttribute:"module_id",defaults:{module_id:null,category:null,name:null,label:"unknown",template:[]},initialize:function(){return this}}),a.cls.collections.documentModules=Backbone.Collection.extend({initialize:function(){return this},model:a.cls.models.documentModule}),a.cls.views.documentModule=Backbone.View.extend({tagName:"li",template:_.template("<%- label %>"),render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this}}),a.cls.views.documentModules=Backbone.View.extend({tagName:"select",initialize:function(){return this},render:function(){return this.collection.each(function(b){var c=new a.cls.views.documentModule({model:b});this.$el.append(c.render().el)},this),this},mk_modSelectOptions:function(){var a="";return this.collection.each(function(b){a+='<option value="'+b.get("module_id")+'">',a+=b.get("label"),a+="</option>"},this),a}})}(window.contConteditor),function(a){var b=0;a.cls.models.moduleContent=Backbone.Model.extend({defaults:{content_id:null,module_id:null,content_data:[],module_label:"unknown"},toJSON:function(){var a={};_.extend(a,this.attributes);for(var b in a.content_data)a.content_data[b].children&&a.content_data[b].children.toJSON&&(a.content_data[b].children=a.content_data[b].children.toJSON(),delete a.content_data[b].childrenView),a.content_data[b].include&&a.content_data[b].include.toJSON&&(a.content_data[b].include=a.content_data[b].include.toJSON(),delete a.content_data[b].includeView);return a},initialize:function(){if(!this.get("content_id")&&this.collection)for(;;){var c="autoid"+b++;if(!this.collection.get({content_id:c})){this.set("content_id",c);break}}var d=a.docModules.get({id:this.get("module_id")});this.set("module_label",d.get("label"));for(var e in d.get("template")){var f=d.get("template")[e].edit_element_id;if(f){if("loop"==d.get("template")[e].func&&this.get("content_data")[f]&&this.get("content_data")[f].children){var f=f;this.attributes.content_data[f].children=new a.cls.collections.moduleContents(this.attributes.content_data[f].children),this.attributes.content_data[f].childrenView=new a.cls.views.moduleContents({collection:this.attributes.content_data[f].children})}"include"==d.get("template")[e].func&&this.get("content_data")[f]&&this.get("content_data")[f].include&&(this.attributes.content_data[f].include=new a.cls.models.moduleContent(this.attributes.content_data[f].include),this.attributes.content_data[f].includeView=new a.cls.views.moduleContent({model:this.attributes.content_data[f].include}))}}return this}}),a.cls.collections.moduleContents=Backbone.Collection.extend({initialize:function(){},model:a.cls.models.moduleContent}),a.cls.views.moduleContent=Backbone.View.extend({tagName:"div",initialize:function(){this.model.on("destroy",this.remove,this),this.model.on("change",this.render,this)},events:{"click .cont_docCont_edit":"uiEdit","click .cont_docCont_up":"uiUp","click .cont_docCont_down":"uiDown","click .cont_docCont_delete":"uiDestroy",mouseover:"uiMouseOver",mouseout:"uiMouseOut"},uiEdit:function(){var b=a.docModules.get({id:this.model.get("module_id")}),c=b.get("template"),d=new a.cls.collections.uiWinEditElements;for(var e in c)"func"==c[e].type&&d.add(c[e]);return new a.cls.views.uiWinEditElements({collection:d}).setTargetModel(this.model).render(),this},uiDestroy:function(){return this.model.destroy(),this},uiUp:function(){return alert("[開発中] 上に並び替えます。"),this},uiDown:function(){return alert("[開発中] 下に並び替えます。"),this},uiMouseOver:function(){return this.$el.css({border:"1px solid #ff0000"}),this.$el.find("button").css({visibility:"visible"}),this},uiMouseOut:function(){return this.$el.css({border:"1px solid transparent"}),this.$el.find("button").css({visibility:"hidden"}),this},remove:function(){return this.$el.remove(),this},template:_.template('<div><%- module_label %>: <%- module_id %><button class="cont_docCont_edit">edit</button><button class="cont_docCont_up">↑</button><button class="cont_docCont_down">↓</button><button class="cont_docCont_delete">delete</button><div class="conteditUI-children"></div></div>'),update:function(){return alert("updated"),this},render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this.uiMouseOut(),this}}),a.cls.views.moduleContents=Backbone.View.extend({tagName:"div",initialize:function(){return this.collection.on("add",this.addNew,this),this},events:{},addNew:function(b){var c=new a.cls.views.moduleContent({model:b});return this.$el.append(c.render().el),this},render:function(){return this.collection.each(function(b){var c=new a.cls.views.moduleContent({model:b});this.$el.append(c.render().el)},this),this}})}(window.contConteditor),function(a){a.cls.editElementUiViews.include=a.cls.views.uiWinEditElementBase.extend({events:{"change select":"update"},update:function(){var b=this.$el.find("select option:selected").attr("value"),c=this.model.get("content_data");c||(c={}),c.module_id=b,c.include=new a.cls.models.moduleContent({module_id:b}),c.includeView=new a.cls.views.moduleContent({model:c.include}),this.model.set("content_data",c)},template:_.template('<th>インクルード</th><td><p>インクルードするモジュールを選択してください。</p><select class="conteditUI-moduleSelector"><option value="">選択してください。</option></select></td>'),render:function(){var b=this.template(this.model.toJSON());return this.$el.html(b),this.$el.find("select").append(a.docModulesView.mk_modSelectOptions()),this.model.get("content_data")&&this.$el.find('select option[value="'+this.model.get("content_data").module_id+'"]').attr({selected:"selected"}),this}})}(window.contConteditor),function(a){a.cls.editElementUiViews.loop=a.cls.views.uiWinEditElementBase.extend({events:{"change input":"update"},update:function(){var b=this.$el.find("input").val(),c=this.model.get("content_data");c||(c={}),c.count=b,c.children=new a.cls.collections.documentModules({}),c.childrenView=new a.cls.views.documentModules({collection:c.children}),this.model.set("content_data",c)},template:_.template('<th>Loop</th><td><p>繰り返し回数を入力してください。</p><input type="text" style="width:30px;" /> 回<br /></td>'),render:function(){var a=this.template(this.model.toJSON());return this.$el.html(a),this.model.get("content_data")&&this.$el.find("input").val(this.model.get("content_data").count),this}})}(window.contConteditor),function(a){a.cls.editElementUiViews.markdown=a.cls.views.uiWinEditElementBase.extend({events:{"change textarea":"update"},update:function(){var a=this.$el.find("textarea").val();this.model.set("content_data",{src:a})},template:_.template('<th>Markdown</th><td><p>マークダウン形式で入力してください。</p><textarea style="width:100%; height:30em;"></textarea></td>')})}(window.contConteditor);